generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // we'll construct this at runtime from Secrets Manager
}

enum ProcessingStatus {
  ENQUEUED
  INGESTED
  FAILED
}

enum FailureReason {
  COMPUTE_EMBEDDINGS_FAILURE
  DATA_LAYER_FAILURE
}

model IdempotencyKey {
  idempotencyKey String   @id
  batchId        String
  createdAt      DateTime @default(now())
}

model Embedding {
  contentHash String                     @id
  embedding   Unsupported("vector(1536)")?
  createdAt   DateTime                  @default(now())

  // Relations
  chunks Chunk[]
}

model Chunk {
  id            String           @id
  contentHash   String
  batchId       String
  clientId      String?
  chunkIndex    Int
  content       String
  status        ProcessingStatus  @default(ENQUEUED)
  failureReason FailureReason?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations - Required FK, but embedding can be NULL initially
  embedding Embedding @relation(fields: [contentHash], references: [contentHash])

  @@index([batchId, chunkIndex])
  @@unique([contentHash, batchId])
}
