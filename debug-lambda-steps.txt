# Updated Lambda Debugging Steps (with real database connection)

## Quick Start (Automated)
./scripts/debug-lambda-local.sh

This script will:
- Auto-detect AWS region and CDK stack
- Fetch secret ARNs from stack outputs
- Check/start database tunnel
- Build Lambda Docker image
- Run Lambda with real database connection via bastion tunnel
- Setup debugger on port 9229

## Manual Steps (if you prefer control)

### 1. Ensure database tunnel is running
./scripts/tunnel-db.sh

### 2. Build Lambda
cd lambdas/ingest-queue-reader
npm ci
npm run build
cd -

### 3. Build Docker image
docker build -f lambdas/ingest-queue-reader/Dockerfile -t ingest-queue-reader:local .

### 4. Run Lambda with real database
# First, get configuration from AWS
source scripts/connect-real-db.sh  # Gets DB credentials
STACK_NAME=$(aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?StackName == 'InfraStack'].StackName" --output text | head -n1)
DB_SECRET_ARN=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='DatabaseSecretArn'].OutputValue" --output text)
OPENAI_SECRET_ARN=$(aws secretsmanager list-secrets --query "SecretList[?starts_with(Name, 'InfraStack-OpenAISecret')].ARN" --output text | head -n1 || echo "")

docker run -d --rm --name lambda-ingest-debug \
  -p 9001:8080 \
  -p 9229:9229 \
  -e NODE_OPTIONS="--enable-source-maps --inspect=0.0.0.0:9229 --inspect-brk" \
  -e AWS_LAMBDA_RUNTIME_API=localhost:9001 \
  -e DB_SECRET_ARN="$DB_SECRET_ARN" \
  -e OPENAI_SECRET_ARN="${OPENAI_SECRET_ARN:-}" \
  -e DB_HOST="host.docker.internal" \
  -e DB_PORT="5432" \
  -e DB_NAME="embeddings" \
  -e LOG_LEVEL="debug" \
  --add-host=host.docker.internal:host-gateway \
  -v "${HOME}/.aws:/root/.aws:ro" \
  ingest-queue-reader:local

### 5. Invoke Lambda
curl -s http://localhost:9001/2015-03-31/functions/function/invocations \
  -H "Content-Type: application/json" \
  --data-binary @sqs-message.json | jq

### 6. View logs
docker logs -f lambda-ingest-debug

### 7. Stop container
docker stop lambda-ingest-debug
