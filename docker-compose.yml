services:
  # Local PostgreSQL database for testing migrations
  postgres:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-embeddings}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-embeddings}"]
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 10s

  hello:
    build:
      context: ./services/hello
      dockerfile: Dockerfile
    environment:
      PORT: "${HELLO_PORT:-3001}"
    ports:
      - "${HELLO_HOST_PORT:-3001}:3001"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/healthz >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 10s

  api:
    build:
      context: .
      dockerfile: ./services/api/Dockerfile
    environment:
      PORT: "${API_PORT:-3000}"
      HELLO_URL: "http://hello:${HELLO_PORT:-3001}"
      HELLO_MOCK: "${HELLO_MOCK:-0}"
      NODE_OPTIONS: "--enable-source-maps"
      # Database connection:
      # - Default: "postgres" (local container)
      # - With bastion tunnel: "host.docker.internal" (macOS/Windows) or host IP (Linux)
      # - Direct RDS: Set DB_HOST to RDS Proxy endpoint (requires VPN/public subnet)
      DB_HOST: "${DB_HOST:-postgres}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-${POSTGRES_DB:-embeddings}}"
      DB_USER: "${DB_USER:-${POSTGRES_USER:-postgres}}"
      DB_PASSWORD: "${DB_PASSWORD:-${POSTGRES_PASSWORD:-postgres}}"
      DB_SSLMODE: "${DB_SSLMODE:-disable}"
      # AWS SQS configuration (passed through from host)
      INGEST_QUEUE_URL: "${INGEST_QUEUE_URL:-}"
      AWS_REGION: "${AWS_REGION:-}"
      AWS_PROFILE: "${AWS_PROFILE:-}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:-}"
      AWS_SESSION_TOKEN: "${AWS_SESSION_TOKEN:-}"
      # OpenAI configuration (passed through from host)
      OPENAI_SECRET: "${OPENAI_SECRET:-}"
    ports:
      - "${API_HOST_PORT:-3000}:3000"
    volumes:
      # Mount AWS credentials directory for profile-based authentication
      - "${HOME}/.aws:/root/.aws:ro"
    extra_hosts:
      # Ensure host.docker.internal works (for database tunnel)
      - "host.docker.internal:host-gateway"
    depends_on:
      hello:
        condition: service_healthy

  api-debug:
    extends: api
    profiles: ["debug"]
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export DATABASE_URL="postgresql://$$(node -e "process.stdout.write(encodeURIComponent(process.env.DB_USER))"):$$(node -e "process.stdout.write(encodeURIComponent(process.env.DB_PASSWORD))")@$$DB_HOST:5432/$$DB_NAME?sslmode=$${DB_SSLMODE:-require}"
        npx prisma migrate deploy
        exec node --enable-source-maps --inspect-brk=0.0.0.0:9229 dist/server.js
    environment:
      NODE_OPTIONS: ""
      # Ensure all environment variables from api are inherited
      PORT: "${API_PORT:-3000}"
      HELLO_URL: "http://hello:${HELLO_PORT:-3001}"
      HELLO_MOCK: "${HELLO_MOCK:-0}"
      # Database connection:
      # - Default: "postgres" (local container)
      # - With bastion tunnel: "host.docker.internal" (macOS/Windows) or host IP (Linux)
      # - Direct RDS: Set DB_HOST to RDS Proxy endpoint (requires VPN/public subnet)
      DB_HOST: "${DB_HOST:-postgres}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-${POSTGRES_DB:-embeddings}}"
      DB_USER: "${DB_USER:-${POSTGRES_USER:-postgres}}"
      DB_PASSWORD: "${DB_PASSWORD:-${POSTGRES_PASSWORD:-postgres}}"
      DB_SSLMODE: "${DB_SSLMODE:-disable}"
      # AWS SQS configuration (passed through from host)
      INGEST_QUEUE_URL: "${INGEST_QUEUE_URL:-}"
      AWS_REGION: "${AWS_REGION:-}"
      AWS_PROFILE: "${AWS_PROFILE:-}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:-}"
      AWS_SESSION_TOKEN: "${AWS_SESSION_TOKEN:-}"
      OPENAI_SECRET: "${OPENAI_SECRET:-}"
    ports:
      - "${API_HOST_PORT:-3000}:3000"
      - "9229:9229"
    volumes:
      - "${HOME}/.aws:/root/.aws:ro"
    depends_on:
      hello:
        condition: service_healthy

  integration-tests:
    build:
      context: .
      dockerfile: ./integration-tests/Dockerfile.test
    environment:
      BASE_URL: "http://InfraS-ApiSe-VsTI6xotjDQp-907190039.eu-west-1.elb.amazonaws.com" # for example
    depends_on:
      api:
        condition: service_started
      hello:
        condition: service_healthy
    profiles:
      - test

volumes:
  postgres_data:
