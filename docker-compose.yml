services:
  hello:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_DIR: services/hello
    environment:
      PORT: "${HELLO_PORT:-3001}"
    ports:
      - "${HELLO_HOST_PORT:-3001}:3001"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/healthz >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 10s

  api:
    image: express-api-docker:prod-${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_DIR: services/api
    environment:
      PORT: "${API_PORT:-3000}"
      HELLO_URL: "http://hello:${HELLO_PORT:-3001}"
      HELLO_MOCK: "${HELLO_MOCK:-0}"
    ports:
      - "${API_HOST_PORT:-3000}:3000"
    depends_on:
      hello:
        condition: service_healthy

  integration-tests:
    build:
      context: ./integration-tests
      dockerfile: ./Dockerfile.test
    environment:
      BASE_URL: "http://api:${API_PORT:-3000}"
    depends_on:
      api:
        condition: service_started
      hello:
        condition: service_healthy
    profiles:
      - test