services:
  hello:
    build:
      context: ./services/hello
      dockerfile: Dockerfile
    environment:
      PORT: "${HELLO_PORT:-3001}"
    ports:
      - "${HELLO_HOST_PORT:-3001}:3001"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/healthz >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 10s

  api:
    build:
      context: .
      dockerfile: ./services/api/Dockerfile
    environment:
      PORT: "${API_PORT:-3000}"
      HELLO_URL: "http://hello:${HELLO_PORT:-3001}"
      HELLO_MOCK: "${HELLO_MOCK:-0}"
      NODE_OPTIONS: "--enable-source-maps"
    ports:
      - "${API_HOST_PORT:-3000}:3000"
    depends_on:
      hello:
        condition: service_healthy

  api-debug:
    extends: api
    profiles: ["debug"]
    command: ["node", "--enable-source-maps", "--inspect-brk=0.0.0.0:9229", "dist/server.js"]
    environment:
      NODE_OPTIONS: ""
    ports:
      - "${API_HOST_PORT:-3000}:3000"
      - "9229:9229"

  integration-tests:
    build:
      context: .
      dockerfile: ./integration-tests/Dockerfile.test
    environment:
      BASE_URL: "http://api:${API_PORT:-3000}"
    depends_on:
      api:
        condition: service_started
      hello:
        condition: service_healthy
    profiles:
      - test
